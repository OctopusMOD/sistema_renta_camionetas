{% extends 'core/base.html' %}

{% block title %}Agregar Mantenimiento{% endblock %}

{% block content %}
    <h1>Agregar Mantenimiento</h1>
    <form method="post" id="mantenimiento-form" onsubmit="return validarFormulario()">
        {% csrf_token %}
        {{ form.as_p }}
        <h3>Líneas de Trabajo</h3>
        {{ formset.management_form }}
        <div id="formset-container">
            {% for form in formset %}
                <div class="formset-row">
                    {{ form.as_p }}
                    {% if not forloop.first %}
                        <button type="button" class="btn remove-row">Eliminar</button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-row" class="btn">Agregar Línea de Trabajo</button>
        <button type="submit" class="btn">Guardar Mantenimiento</button>
    </form>
    <a href="{% url 'lista_mantenimientos' %}" class="btn">Cancelar</a>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para validar las fechas y campos requeridos
        function validarFormulario() {
            const fechaInicio = document.getElementById('id_fecha_inicio').value;
            const fechaFin = document.getElementById('id_fecha_fin').value;

            if (!fechaInicio || !fechaFin) {
                alert('Por favor, completa las fechas de inicio y fin.');
                return false;
            }

            const fechaInicioDate = new Date(fechaInicio);
            const fechaFinDate = new Date(fechaFin);
            if (fechaFinDate < fechaInicioDate) {
                alert('La fecha de fin no puede ser anterior a la fecha de inicio.');
                return false;
            }

            const formsetRows = document.querySelectorAll('.formset-row');
            for (let row of formsetRows) {
                const descripcion = row.querySelector('input[id*="descripcion"]').value;
                const cantidad = row.querySelector('input[id*="cantidad"]').value;
                const valorUnitario = row.querySelector('input[id*="valor_unitario"]').value;

                if (!descripcion || !cantidad || !valorUnitario) {
                    alert('Por favor, completa todos los campos de las líneas de trabajo.');
                    return false;
                }

                if (cantidad <= 0 || valorUnitario <= 0) {
                    alert('La cantidad y el valor unitario deben ser mayores que 0.');
                    return false;
                }
            }

            return true;
        }

        // Función para agregar una nueva fila
        const addRowButton = document.getElementById('add-row');
        if (addRowButton) {
            addRowButton.addEventListener('click', function() {
                const templateRow = document.querySelector('.formset-row');
                if (!templateRow) {
                    alert('No hay una fila para clonar.');
                    return;
                }

                const newRow = templateRow.cloneNode(true);

                const inputs = newRow.querySelectorAll('input');
                inputs.forEach(input => {
                    input.value = '';
                    const oldId = input.id;
                    const oldName = input.name;
                    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
                    const currentTotal = parseInt(totalForms.value);
                    const newIndex = currentTotal;
                    totalForms.value = currentTotal + 1;

                    const newId = oldId.replace(/-\d+-/, '-' + newIndex + '-');
                    const newName = oldName.replace(/-\d+-/, '-' + newIndex + '-');
                    input.id = newId;
                    input.name = newName;
                });

                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'btn remove-row';
                removeButton.textContent = 'Eliminar';
                newRow.appendChild(removeButton);

                document.getElementById('formset-container').appendChild(newRow);

                removeButton.addEventListener('click', function() {
                    newRow.remove();
                    totalForms.value = parseInt(totalForms.value) - 1;
                });
            });
        } else {
            console.error('No se encontró el botón con id="add-row".');
        }

        // Añadir evento para eliminar filas existentes
        document.querySelectorAll('.remove-row').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.parentElement;
                row.remove();
                const totalForms = document.getElementById('id_form-TOTAL_FORMS');
                totalForms.value = parseInt(totalForms.value) - 1;
            });
        });
    });
</script>