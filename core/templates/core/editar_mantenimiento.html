{% extends 'core/base.html' %}

    {% block title %}Editar Mantenimiento{% endblock %}

    {% block content %}
        <h1>Editar Mantenimiento</h1>
        <form method="post" id="mantenimiento-form" onsubmit="return validarFormulario()">
            {% csrf_token %}
            {{ form.as_p }}
            <h3>Líneas de Trabajo</h3>
            {{ formset.management_form }}
            <div id="formset-container">
                {% for form in formset %}
                    <div class="formset-row">
                        {{ form.as_p }}
                        {% if not forloop.first %}
                            <button type="button" class="btn remove-row">Eliminar</button>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-row" class="btn">Agregar Línea de Trabajo</button>
            <button type="submit" class="btn">Guardar Cambios</button>
        </form>
        <a href="{% url 'lista_mantenimientos' %}" class="btn">Cancelar</a>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Script cargado correctamente.");

            const totalFormsInitial = document.getElementById('id_form-TOTAL_FORMS');
            console.log("Campo id_form-TOTAL_FORMS:", totalFormsInitial);
            if (!totalFormsInitial) {
                console.error("El campo id_form-TOTAL_FORMS no se encontró.");
                return;
            }

            const addRowButton = document.getElementById('add-row');
            console.log("Botón add-row:", addRowButton);

            const formsetContainer = document.getElementById('formset-container');
            console.log("Contenedor formset:", formsetContainer);
            const initialRows = document.querySelectorAll('.formset-row');
            console.log("Filas iniciales encontradas:", initialRows.length);

            function validarFormulario() {
                console.log("Validando formulario...");
                const fechaInicio = document.getElementById('id_fecha_inicio').value;
                const fechaFin = document.getElementById('id_fecha_fin').value;

                if (!fechaInicio || !fechaFin) {
                    alert('Por favor, completa las fechas de inicio y fin.');
                    return false;
                }

                const fechaInicioDate = new Date(fechaInicio);
                const fechaFinDate = new Date(fechaFin);
                if (fechaFinDate < fechaInicioDate) {
                    alert('La fecha de fin no puede ser anterior a la fecha de inicio.');
                    return false;
                }

                const formsetRows = document.querySelectorAll('.formset-row');
                for (let row of formsetRows) {
                    const descripcionInput = row.querySelector('input[id*="descripcion"]');
                    const cantidadInput = row.querySelector('input[id*="cantidad"]');
                    const valorUnitarioInput = row.querySelector('input[id*="valor_unitario"]');
                    const deleteInput = row.querySelector('input[type="checkbox"][id*="DELETE"]');

                    if (!descripcionInput || !cantidadInput || !valorUnitarioInput) {
                        console.error("No se encontraron todos los campos en una fila del formset:", row);
                        alert('Error en los campos de las líneas de trabajo.');
                        return false;
                    }

                    const descripcion = descripcionInput.value;
                    const cantidad = cantidadInput.value;
                    const valorUnitario = valorUnitarioInput.value;

                    if (!descripcion || !cantidad || !valorUnitario) {
                        alert('Por favor, completa todos los campos de las líneas de trabajo.');
                        return false;
                    }

                    if (cantidad <= 0 || valorUnitario <= 0) {
                        alert('La cantidad y el valor unitario deben ser mayores que 0.');
                        return false;
                    }
                }

                return true;
            }

            if (addRowButton) {
                addRowButton.addEventListener('click', function() {
                    console.log("Botón 'Agregar Línea de Trabajo' presionado.");
                    const templateRow = document.querySelector('.formset-row');
                    if (!templateRow) {
                        console.error('No hay una fila para clonar.');
                        alert('No hay una fila para clonar.');
                        return;
                    }

                    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
                    if (!totalForms) {
                        console.error("No se encontró id_form-TOTAL_FORMS.");
                        return;
                    }

                    const newRow = templateRow.cloneNode(true);
                    const inputs = newRow.querySelectorAll('input');
                    inputs.forEach(input => {
                        input.value = '';
                        const oldId = input.id;
                        const oldName = input.name;
                        const currentTotal = parseInt(totalForms.value);
                        const newIndex = currentTotal;
                        totalForms.value = currentTotal + 1;

                        const newId = oldId.replace(/-\d+-/, '-' + newIndex + '-');
                        const newName = oldName.replace(/-\d+-/, '-' + newIndex + '-');
                        input.id = newId;
                        input.name = newName;
                    });

                    const removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.className = 'btn remove-row';
                    removeButton.textContent = 'Eliminar';
                    newRow.appendChild(removeButton);

                    formsetContainer.appendChild(newRow);

                    removeButton.addEventListener('click', function() {
                        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
                        if (!totalForms) {
                            console.error("No se encontró id_form-TOTAL_FORMS para eliminar.");
                            return;
                        }
                        newRow.remove();
                        totalForms.value = parseInt(totalForms.value) - 1;
                        console.log("Fila eliminada. Total de formas:", totalForms.value);
                    });

                    console.log("Nueva fila añadida:", newRow);
                });
            } else {
                console.error('No se encontró el botón con id="add-row".');
            }

            document.querySelectorAll('.remove-row').forEach(button => {
                button.addEventListener('click', function() {
                    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
                    if (!totalForms) {
                        console.error("No se encontró id_form-TOTAL_FORMS para eliminar.");
                        return;
                    }
                    const row = this.parentElement;
                    row.remove();
                    totalForms.value = parseInt(totalForms.value) - 1;
                    console.log("Fila eliminada. Total de formas:", totalForms.value);
                });
            });
        });
        </script>
    {% endblock %}